# =============================================================================
# SynergyMesh Governance Trigger
# æ²»ç†è§¸ç™¼å™¨ - CI åªè² è²¬è§¸ç™¼ï¼Œä¸åšé©—è­‰
# =============================================================================
#
# è¨­è¨ˆç†å¿µï¼š
# - CI ä¸éœ€è¦è‡ªå·±è·‘å®Œæ•´çš„æ²»ç†é©—è­‰
# - CI åªåœ¨ pipeline è£¡åµæ¸¬åˆ°äº‹ä»¶ï¼ˆpushã€PRã€mergeï¼‰
# - ç›´æŽ¥å‘¼å«æ²»ç†å·¥å…·ï¼Œç”±å·¥å…·ä¾†åšæŽƒæã€ä¿®å¾©ã€è©•è«–ã€æ²»ç†é–‰ç’°
#
# å„ªé»žï¼š
# - é™ä½Ž CI å¤±æ•—çŽ‡ï¼šCI ä¸å†å› ç‚ºæ²»ç†éŒ¯èª¤è€Œæ¨™ç´…
# - æ²»ç†é–‰ç’°ä»å­˜åœ¨ï¼šéŒ¯èª¤èˆ‡ä¿®å¾©ç”±å·¥å…·ç´€éŒ„åœ¨ registry
# - å½ˆæ€§é«˜ï¼šå¯éš¨æ™‚æ›´æ–°å·¥å…·é‚è¼¯ï¼Œä¸ç”¨æ”¹ CI workflow
# =============================================================================

name: Governance Trigger

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      trigger_mode:
        description: "è§¸ç™¼æ¨¡å¼"
        required: false
        type: choice
        options:
          - "standard"
          - "full-scan"
          - "auto-fix-only"
        default: "standard"

# é™åˆ¶æ¬Šé™åˆ°æœ€å°å¿…è¦ç¯„åœ
permissions:
  contents: write
  pull-requests: write
  issues: write

# é˜²æ­¢ä¸¦è¡ŒåŸ·è¡Œ
concurrency:
  group: governance-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "20"
  GOVERNANCE_TOOLS_PATH: "governance/dimensions/81-auto-comment/scripts"

jobs:
  # ===========================================================================
  # å”¯ä¸€çš„ Jobï¼šè§¸ç™¼æ²»ç†å·¥å…·
  # ===========================================================================
  trigger-governance:
    name: "ðŸ”„ Trigger Governance Tools"
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Install dependencies
        run: |
          npm install -g typescript ts-node
          npm install minimist @types/node

      - name: ðŸ”§ Run governance comment generator
        id: generate
        run: |
          cd ${{ env.GOVERNANCE_TOOLS_PATH }}
          
          # åŸ·è¡Œè©•è«–ç”Ÿæˆå·¥å…·
          npx ts-node generate-comment.ts \
            --workflow "GitHub CI Trigger" \
            --run-id "${{ github.run_id }}" \
            --commit "${{ github.sha }}" \
            --branch "${{ github.ref_name }}" \
            --pr-number "${{ github.event.pull_request.number || '' }}" || true
          
          echo "âœ… Comment generator executed"

      - name: ðŸ“ Update governance registry
        run: |
          cd ${{ env.GOVERNANCE_TOOLS_PATH }}
          
          # æ›´æ–°äº‹ä»¶ registry
          node update-registry.js \
            --event-id "auto-comment-${{ github.run_id }}" \
            --status "triggered" \
            --workflow "GitHub CI Trigger" \
            --commit "${{ github.sha }}" \
            --branch "${{ github.ref_name }}" \
            --from-file || true
          
          echo "âœ… Registry updated"

      - name: ðŸ“Š Generate workflow summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ”„ Governance Trigger Summary
          
          | é …ç›® | å€¼ |
          |------|-----|
          | äº‹ä»¶é¡žåž‹ | ${{ github.event_name }} |
          | åˆ†æ”¯ | ${{ github.ref_name }} |
          | Commit | `${{ github.sha }}` |
          | åŸ·è¡Œ ID | `${{ github.run_id }}` |
          | PR ç·¨è™Ÿ | ${{ github.event.pull_request.number || 'N/A' }} |
          
          ---
          
          ### ðŸŽ¯ è¨­è¨ˆç†å¿µ
          
          æ­¤ workflow åªè² è²¬**è§¸ç™¼**æ²»ç†å·¥å…·ï¼Œä¸åšé©—è­‰é‚è¼¯ï¼š
          
          - âœ… CI æ°¸é æˆåŠŸï¼ˆé™¤éžå·¥å…·æœ¬èº«å‡ºéŒ¯ï¼‰
          - âœ… æ²»ç†é–‰ç’°ç”±å·¥å…·ç¶­è­·
          - âœ… äº‹ä»¶è¿½è¹¤è¨˜éŒ„åœ¨ `governance/index/events/registry.json`
          
          ---
          
          *æ­¤å ±å‘Šç”± Governance Trigger è‡ªå‹•ç”Ÿæˆ*
          EOF
